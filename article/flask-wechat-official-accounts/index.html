<!doctype html>
<html class="no-js" lang="tc">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Fancy">
    <meta name="description" content="Bilberry Premium Theme for Hugo.">
    <meta name="keywords" content="blog,personal,responsive,search,font awesome,pages,posts,multilingual,highlight.js,syntax highlighting,premium,shortcuts">
    <meta name="generator" content="Hugo 0.67.0" />
    <title> 使用Flask創建微信公眾號 | Fancy‘s Blog</title>
    <meta name="description" content="使用Flask創建微信公眾號 - Bilberry Premium Theme for Hugo.">
    <meta itemprop="name" content="使用Flask創建微信公眾號">
    <meta itemprop="description" content="使用Flask創建微信公眾號 - Bilberry Premium Theme for Hugo.">
    <meta property="og:title" content="使用Flask創建微信公眾號">
    <meta property="og:description" content="使用Flask創建微信公眾號 - Bilberry Premium Theme for Hugo.">
    <meta property="og:image" content="https://www.gravatar.com/avatar/3776f719d93bf9d357bf83b6e50e10d6?size=200">
    <meta property="og:url" content="https://bbyy.io/article/flask-wechat-official-accounts/">
    <meta property="og:site_name" content="Fancy‘s Blog">
    <meta property="og:type" content="article">

    
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#e2619c">
<meta name="msapplication-TileColor" content="#e2619c">
<meta name="theme-color" content="#e2619c">

    
    <link href="/article/flask-wechat-official-accounts/" rel="alternate" type="application/rss+xml" title="Fancy‘s Blog" />
    <link href="/article/flask-wechat-official-accounts/" rel="feed" type="application/rss+xml" title="Fancy‘s Blog" />
    

    

    <link rel="stylesheet" href="https://bbyy.io/theme.css">

    

    
    
    
</head>

<body class="bilberry-hugo-theme">

    
    <nav class="permanentTopNav sticky">

    <div class="container">
        <ul class="topnav">
            
            
            <li><a href="https://bbyy.io/page/about-me/">關於本人</a></li>
            
            
        </ul>

        
        <div id="search-box" class="search">
            <i class="fas fa-search"></i>
            <input id="search" type="text" placeholder="">
        </div>
        
    </div>
</nav>


    
<header class="sticky">

    <div class="container">
        <div class="logo">
            <a id="siteBaseUrl" href="/" class="logo">
                
                <img src="https://www.gravatar.com/avatar/3776f719d93bf9d357bf83b6e50e10d6?d=mm&size=200" alt="">
                

                <span class="overlay"><i class="fa fa-tape"></i></span>
            </a>
        </div>
        <div class="titles">
            <h3 class="title"><a
                    href="/">Fancy‘s Blog</a></h3>
            
            <span class="subtitle">Fancy的個人Blog，技術Blog可移步SC語言</span>
            
        </div>

        <div class="languages">
        
            
                <a href="https://bbyy.io/" class="active">tc</a>
            
        
            
                <a href="https://bbyy.io/sc/">sc</a>
            
        
            
                <a href="https://bbyy.io/en/">en</a>
            
        
        </div>
        

        
        <div class="toggler permanentTopNav">
            
                <i class="fa fa-bars" aria-hidden="true"></i>
            </div>
        </div>
</header>


    <div class="main container">
        
     
    <div class="article-wrapper u-cf single">
        
            <a class="bubble" href="https://bbyy.io/article/flask-wechat-official-accounts/">
    <i class="fas fa-fw fa-pencil-alt"></i>
</a>

<article class="default article">
    
    <div class="featured-image">
        <a href="https://bbyy.io/article/flask-wechat-official-accounts/">
            
                <img src="/article/flask-wechat-official-accounts/featuredImage.png" alt="">
            
        </a>
    </div>


    <div class="content">
    <h1 class="article-title"><a href="https://bbyy.io/article/flask-wechat-official-accounts/">使用Flask創建微信公眾號</a></h1>
    <div class="meta">
        
        
        <span class="date moment">2018-11-26</span>
        
        

        

        
        <span class="categories">
            
                
                <a href="https://bbyy.io/categories/code/">Code</a>
                
            
        </span>
        

        
        <span class="author">
            
            <a href="https://bbyy.io/author/fancy/">Fancy</a>
            
        </span>
        
    </div>

    
    <p>基於Flask搭建微信公眾號後台</p>
<blockquote>
<p>這次先用Flask為微信公眾號做個後台。微信公眾號後台一般對性能各方面要求並不高，這裏我們以新浪SAE為例，其他已解析域名的服務器同理。整個過程比較簡單，算是個快速的小項目吧</p>
</blockquote>
<ul>
<li>部署環境為python3+pipenv+flask+uwsgi/gunicorn+supervisor+nginx 其中我們uwsgi和gunicorn我會同步對比部署，篇幅太長主題不明，主要內容留在下篇，這裏先說實現的問題吧</li>
</ul>
<h2 id="部署服務器"><strong>部署服務器</strong></h2>
<hr>
<p>可以點擊鏈接進行註冊 說起新浪SAE(SinaAppEngine)類屬Paas，這個還是比較不穩定的，好在前期不花錢，自帶二級域名和HTTPS，控制台直接操作ssh秘鑰，不支持系統內ssh密鑰相比之下很適合做測試和微信這些。</p>
<p><a href="https://link.zhihu.com/?target=http%3A//www.sinacloud.com/public/login/inviter/gaimrn-mddmzeKWrhKWnaYGuibB-no1qfnyudg.html">註冊地址</a> 新浪SAE有提供免費的基於GIT的Python2.7共享環境，這裏不用這個，實在是太難受了，我們選擇自定義一個，選擇手工部署Ubuntu，倘若Centos的弄nginx這些有點煩。</p>
<p><img src="https://pic2.zhimg.com/80/v2-e555aa9c29772b5b8f038072259d7309_1440w.jpg" alt="img"></p>
<p>新浪雲的Ubuntu新建用戶後是無法ssh秘鑰登陸的，在控制台改ssh秘鑰。就忍受著用root用戶吧。其他服務器用戶還是新建用戶比較安全。寫文章雖然用的新浪雲示範，往後的代碼裏為了區別權限都加上<code>sudo</code></p>
<p>如果是新浪SAE記下自定義的二級域名，等下會用到</p>
<p><img src="https://pic3.zhimg.com/80/v2-c82a680bde155a4eb6236f5c948020d6_1440w.jpg" alt="img"></p>
<p>管理可以點控制台/應用/容器管理。這裏我們註意框住的這句話，無論80還是443，新浪只開放了<code>5050</code>端口給我們。HTTPS也通用。這裏後面都會用到</p>
<p><img src="https://pic1.zhimg.com/80/v2-f99e3484018af4155a4d24f56fc87b88_1440w.jpg" alt="img"></p>
<h2 id="接入微信公眾號"><strong>接入微信公眾號</strong></h2>
<hr>
<p>進入微信公眾平台，如果沒有公眾號的話按<a href="https://link.zhihu.com/?target=https%3A//kf.qq.com/faq/120911VrYVrA151009eIrYvy.html">流程申請</a>即可，從主頁中下滑，在左導航欄中最下面進入到 / 開發 / 基本配置界面。勾選協議成為開發者，</p>
<p><img src="https://pic3.zhimg.com/80/v2-51654ad92fbe19b96d525aa90d334352_1440w.jpg" alt="img"></p>
<p>點擊“修改配置”按鈕，填寫服務器地址（URL）、Token和EncodingAESKey，URL是與服務器通信接口的接口URL，我們填入服務器的解析域名（SAE的二級域名）後跟一個自定義路由，http和https都可以，新浪雲自帶有https這是沒問題的。Token可由開發者自由填寫，用作生成簽名（該Token會和接口URL中包含的Token進行哈希值比對驗證安全性）將用作消息體加解密密鑰。我們點隨機生成，</p>
<p>微信後台接受一個GET請求需要的參數如下：</p>
<p><img src="https://pic4.zhimg.com/80/v2-8c05612b193ba1a7c6e7651fdf17dd5f_1440w.jpg" alt="img"></p>
<blockquote>
<p>1）將token、timestamp、nonce三個參數進行字典序排序 2）將三個參數字符串拼接成一個字符串進行sha1加密 3）開發者獲得加密後的字符串可與signature對比，標識該請求來源於微信</p>
</blockquote>
<p>據微信的要求，我們嘗試編寫flask後台。先部署下基本環境</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo apt update &amp; upgrade
$ sudo apt install python3-dev python3-pip
$ sudo pip3 install pipenv
</code></pre></div><p>不是新浪SAE強烈建議創建<code>adduser</code>新用戶，並<code>usermod -aG sudo</code>賦予權限。創建ssh密鑰登錄並關閉密碼登錄。 創建pipenv環境並進入安裝flask這些就不多說了。如果未測試的話可以先簡單編寫個測試</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask

app <span style="color:#f92672">=</span> Flask(__name__)

<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/&#34;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello</span>():
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hello World!&#34;</span>

 <span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/wechat_api/&#39;</span>)
 <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wechat</span>():
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    app<span style="color:#f92672">.</span>run(debug<span style="color:#f92672">=</span>True)
    <span style="color:#75715e"># app.run(host=&#39;0.0.0.0&#39;, port=5050)</span>
</code></pre></div><p>新浪SAE需要指定5050端口，Flask運行app.run()是默認的127.0.0.1:5000, 我們使用註釋裏的指定host參數即可外網訪問。這是我們輸入域名進入，可以看到<code>Hello World!</code>即可。</p>
<p>創建一個接口，參考微信提供的php編寫flask，填入token和自定義的路由，</p>
<p><em>base.py：</em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> hashlib

<span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, request, make_response
<span style="color:#f92672">import</span> xml.etree.ElementTree <span style="color:#f92672">as</span> ET

WX_TOKEN <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;fancy&#39;</span>
<span style="color:#75715e"># 這裏填寫公眾號配置的token</span>

app <span style="color:#f92672">=</span> Flask(__name__)
app<span style="color:#f92672">.</span>debug <span style="color:#f92672">=</span> True


<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/&#34;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello</span>():
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hello World!&#34;</span>

<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/wechat_api/&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
<span style="color:#75715e"># 定義路由地址請與URL後的保持一致</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wechat</span>():
    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;GET&#39;</span>:
    token <span style="color:#f92672">=</span> WX_TOKEN
    data <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args
    signature <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;signature&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)
    timestamp <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;timestamp&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)
    nonce <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;nonce&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)
    echostr <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;echostr&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)
    s <span style="color:#f92672">=</span> sorted([timestamp, nonce, token])
    <span style="color:#75715e"># 字典排序</span>
    s <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(s)
    <span style="color:#66d9ef">if</span> hashlib<span style="color:#f92672">.</span>sha1(s<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))<span style="color:#f92672">.</span>hexdigest() <span style="color:#f92672">==</span> signature:
        <span style="color:#75715e"># 判斷請求來源，並對接受的請求轉換為utf-8後進行sha1加密</span>
        response <span style="color:#f92672">=</span> make_response(echostr)
        <span style="color:#75715e"># response.headers[&#39;content-type&#39;] = &#39;text&#39; </span>
        <span style="color:#75715e"># 新浪SAE未實名用戶加上上面這句</span>
        <span style="color:#66d9ef">return</span> response

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
app<span style="color:#f92672">.</span>run()
<span style="color:#75715e"># app.run(host=&#39;0.0.0.0&#39;, port=5050)</span>
</code></pre></div><p>然後回到微信服務器配置的地方選擇明文模式或者兼容模式。點選提交，</p>
<p><img src="https://pic1.zhimg.com/80/v2-57e77aa10d663885f708d588cb7f89e0_1440w.jpg" alt="img"></p>
<p>我遇到問題。由於我新浪SAE未實名還未審核通過，新郎SAE對未實名的在返回值內會帶上奇怪的的html內容信息，從而導致Token驗證失敗。我們在返回值的頭部帶上<code>'content-type' = 'text'</code>即可。</p>
<p>到此，點擊提交，應該就沒問題了，如果顯示Token驗證失敗，請回頭再次檢查一遍</p>
<h2 id="接入後的應答"><strong>接入後的應答</strong></h2>
<p>我們查看微信的文檔，微信是這樣說的：</p>
<p><a href="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/wiki%3Ft%3Dresource/res_main%26id%3Dmp1421140453">微信收到的消息類型結構mp.weixin.qq.com</a><a href="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/wiki%3Ft%3Dresource/res_main%26id%3Dmp1421140543">微信被動回覆用戶消息結構mp.weixin.qq.com</a></p>
<p>還有一個接收事件推送，介於篇幅問題，這個留作下下次再說。 微信提供給開發者的通信接口是xml格式的，確實一直處理json，用xml還是感覺比較難受。這裏使用 xml.etree.ElementTree 來解析。</p>
<p>分類有文本<code>text</code>，圖片<code>image</code>，語音<code>voice</code>，視頻<code>video</code>，小視頻<code>shortvideo</code>，地理位置<code>location</code>，鏈接<code>link</code>。 這裏由於沒有太多硬性的功能，我希望簡單化用戶的操作，將功能全部先融合在輸入框，根據用戶輸入的內容做出相應的判斷，如果無法判斷時或者沒實際意義時，判斷你可能只想聊天，再調用聊天機器人。</p>
<p>思路是初步判斷消息類型，然後再逐個if-elif篩選下來。 - 首先判斷文字模塊，微信POST過來的XML數據包結構：</p>
<p><img src="https://pic1.zhimg.com/80/v2-a7c40e3249a96afff0f8d392dbfdc5b8_1440w.jpg" alt="img"></p>
<p>判斷一個<code>MsgType</code>，主要用到的<code>ToUserName</code>，<code>FromUserName</code>，<code>Content</code>，我們先看如何回覆文本消息：</p>
<p><img src="https://pic4.zhimg.com/80/v2-dda1520952aeccaf1878100378a89f5f_1440w.jpg" alt="img"></p>
<p>那麽好了，<code>ToUserName</code>，<code>FromUserName</code>實際在收發過程中是調轉的，利用time()生成整型時間，我們先把結構起好 微信這裏原來的GET請求驗證不能刪除，除此之外的POST我們直接else處理即可。</p>
<h2 id="最開始和最後圖靈機器人"><strong>最開始和最後——圖靈機器人</strong></h2>
<p><em>main.py:</em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> tuling <span style="color:#f92672">import</span> get_response
<span style="color:#f92672">import</span> xml.etree.ElementTree <span style="color:#f92672">as</span> ET
<span style="color:#75715e"># ...</span>
<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/wechat_api/&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wechat</span>():
    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;GET&#39;</span>:
    <span style="color:#75715e">#...</span>
    <span style="color:#66d9ef">else</span>:
        xml <span style="color:#f92672">=</span> ET<span style="color:#f92672">.</span>fromstring(request<span style="color:#f92672">.</span>data)
        toUser <span style="color:#f92672">=</span> xml<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;ToUserName&#39;</span>)<span style="color:#f92672">.</span>text
        fromUser <span style="color:#f92672">=</span> xml<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;FromUserName&#39;</span>)<span style="color:#f92672">.</span>text
        msgType <span style="color:#f92672">=</span> xml<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#34;MsgType&#34;</span>)<span style="color:#f92672">.</span>text

        <span style="color:#66d9ef">if</span> msgType <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;text&#39;</span>:
            content <span style="color:#f92672">=</span> xml<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;Content&#39;</span>)<span style="color:#f92672">.</span>text
            <span style="color:#66d9ef">return</span> reply_text(
                fromUser, toUser, get_response(
                    fromUser, content))
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">return</span> reply_text(fromUser, toUser, <span style="color:#e6db74">&#34;嗯？我聽不太懂&#34;</span>)
</code></pre></div><p>微信要求必須回覆success（建議）或者空字符串防止輪詢，我這裏先將未分類的消息回覆text這樣感覺不會不理人。get_response 先判斷一個<code>text</code>消息，接收<code>Content</code>再做判斷是否為關鍵語句再針對回覆。倘若沒有即調用<code>圖靈機器人</code>。 我們用的v2的api，用的是post請求一個json，json比較簡單，這邊不多說了，按<a href="https://link.zhihu.com/?target=https%3A//www.kancloud.cn/turing/www-tuling123-com/718227">API V2.0接入文檔</a>的示例即可</p>
<p><em>tuling.py:</em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> json
<span style="color:#f92672">import</span> requests

TULING_KEY <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#39;TULING_KEY&#39;</span>)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_response</span>(openid, msg):
    api <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;http://openapi.tuling123.com/openapi/api/v2&#39;</span>
    dat <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#34;perception&#34;</span>: {
            <span style="color:#e6db74">&#34;inputText&#34;</span>: {
                <span style="color:#e6db74">&#34;text&#34;</span>: msg
            },
            <span style="color:#e6db74">&#34;inputImage&#34;</span>: {
                <span style="color:#e6db74">&#34;url&#34;</span>: <span style="color:#e6db74">&#34;imageUrl&#34;</span>
            },
            <span style="color:#e6db74">&#34;selfInfo&#34;</span>: {
                <span style="color:#e6db74">&#34;location&#34;</span>: {
                    <span style="color:#e6db74">&#34;city&#34;</span>: <span style="color:#e6db74">&#34;北京&#34;</span>,
                    <span style="color:#e6db74">&#34;province&#34;</span>: <span style="color:#e6db74">&#34;北京&#34;</span>,
                    <span style="color:#e6db74">&#34;street&#34;</span>: <span style="color:#e6db74">&#34;信息路&#34;</span>
                }
            }
        },
        <span style="color:#e6db74">&#34;userInfo&#34;</span>: {
            <span style="color:#e6db74">&#34;apiKey&#34;</span>: TULING_KEY,
            <span style="color:#e6db74">&#34;userId&#34;</span>: openid
        }
    }
    dat <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>dumps(dat)
    r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(api, data<span style="color:#f92672">=</span>dat)<span style="color:#f92672">.</span>json()

    mesage <span style="color:#f92672">=</span> r[<span style="color:#e6db74">&#39;results&#39;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#e6db74">&#39;text&#39;</span>]
    <span style="color:#66d9ef">print</span>(r[<span style="color:#e6db74">&#39;results&#39;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#e6db74">&#39;text&#39;</span>])
    <span style="color:#66d9ef">return</span> mesage
</code></pre></div><p>輸出我們暫時只要<code>results</code>裏的<code>values</code>輸出值，取值範圍是文本<code>text</code>，後期再一點點補充。 APIkey可以在這裏找到</p>
<p><img src="https://pic2.zhimg.com/80/v2-1e97cd41c0b32618cadd4a5258e9121d_1440w.jpg" alt="img"></p>
<p>- 圖靈機器人支持直接接入公眾號，這件事就當我不知道 - 更新：圖靈機器人支持關鍵詞回覆，可以添加各種語料庫。這裏目前沒有回覆覆雜消息的需求就先簡化代碼。</p>
<p>回覆微信的xml格式按照要求處理即可， <em>main.py:</em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> time
<span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span>  make_response
<span style="color:#75715e"># ...</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">reply_text</span>(to_user, from_user, content):
    reply <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    &lt;xml&gt;&lt;ToUserName&gt;&lt;![CDATA[</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">]]&gt;&lt;/ToUserName&gt;
</span><span style="color:#e6db74">    &lt;FromUserName&gt;&lt;![CDATA[</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">]]&gt;&lt;/FromUserName&gt;
</span><span style="color:#e6db74">    &lt;CreateTime&gt;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&lt;/CreateTime&gt;
</span><span style="color:#e6db74">    &lt;MsgType&gt;&lt;![CDATA[text]]&gt;&lt;/MsgType&gt;
</span><span style="color:#e6db74">    &lt;Content&gt;&lt;![CDATA[</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">]]&gt;&lt;/Content&gt;
</span><span style="color:#e6db74">    &lt;FuncFlag&gt;0&lt;/FuncFlag&gt;&lt;/xml&gt;
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    response <span style="color:#f92672">=</span> make_response(reply <span style="color:#f92672">%</span> (to_user, from_user,
                                      str(int(time<span style="color:#f92672">.</span>time())), content))
    response<span style="color:#f92672">.</span>content_type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;application/xml&#39;</span>
    <span style="color:#66d9ef">return</span> response
</code></pre></div><p>至此本地測試通過後用git方式什麽都好推送到服務器端，運行python main.py應該手機端發送就沒問題的。</p>
<p><img src="https://pic2.zhimg.com/80/v2-cf0b1fd33a5f472ced550e440089bb1d_1440w.jpg" alt="img"></p>
<p>附：官方提供的</p>
<p><a href="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/debug/cgi-bin/apiinfo%3Ft%3Dindex%26type%3D%E8%87%AA%E5%AE%9A%E4%B9%89%E8%8F%9C%E5%8D%95%26form%3D%E8%87%AA%E5%AE%9A%E4%B9%89%E8%8F%9C%E5%8D%95%E5%88%9B%E5%BB%BA%E6%8E%A5%E5%8F%A3%20/menu/creat">微信公眾平台接口調試工具mp.weixin.qq.com</a></p>
<p>這才剛剛開始，下一篇裏我針對性的嘗試探究下程序必須的措施<code>pipenv+uwsgi/gunicorn+supervisor+nginx</code>的部署，部署幾次都沒好好總結</p>
    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                
                <a href="https://bbyy.io/tags/flask/">Flask</a>
                
                
                
                <a href="https://bbyy.io/tags/python/">Python</a>
                
                
                
                <a href="https://bbyy.io/tags/wechat/">Wechat</a>
                
                
            </div>
        </div>
    

    
    <div class="languages">
        <i class="fa fa-language"></i>
        <div class="links">
            
                <a href="https://bbyy.io/sc/article/flask-wechat-official-accounts/">sc</a>
            
        </div>
    </div>
    
</div>

</article>

        
    </div>

    
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hallucigenia" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

     

    </div>

    
<footer>
    <div class="container">

        
        <div class="recent-posts">
            <strong></strong>
            <ul>
                
                <li>
                    <a href="https://bbyy.io/code/getting-started-gdb/">Python標準庫 —— pdb調試工具使用</a>
                </li>
                
                <li>
                    <a href="https://bbyy.io/gallery/gallery-test/">我的旅游记录</a>
                </li>
                
                <li>
                    <a href="https://bbyy.io/code/openpyxl_tutorial/">Openpyxl使用 —— Python操作Excel文件總結</a>
                </li>
                
                <li>
                    <a href="https://bbyy.io/audio/you-xin-ren/">有心人 - 張國榮</a>
                </li>
                
                <li>
                    <a href="https://bbyy.io/code/gunicorn-supervisor-deploy/">Gunicorn Supervisor Deploy</a>
                </li>
                
                <li>
                    <a href="https://bbyy.io/link/shodan.io/">shodan.io</a>
                </li>
                
            </ul>
        </div>
        

        
        <div class="categories">
            <a href="/categories/"><strong></strong></a>
            <ul>
                
                <li>
                    <a href="/categories/code">Code
                        (4)</a>
                </li>
                
                <li>
                    <a href="/categories/holidays">Holidays
                        (1)</a>
                </li>
                
                <li>
                    <a href="/categories/lyric">Lyric
                        (1)</a>
                </li>
                
                <li>
                    <a href="/categories/music">Music
                        (1)</a>
                </li>
                
                <li>
                    <a href="/categories/privacy">Privacy
                        (1)</a>
                </li>
                
                <li>
                    <a href="/categories/travelling">Travelling
                        (1)</a>
                </li>
                
                <li>
                    <a href="/categories/%E7%9B%A3%E8%A6%96%E5%99%A8">監視器
                        (1)</a>
                </li>
                
            </ul>
        </div>
        

        <div class="right">
            
            <div class="external-profiles">
                <strong></strong>

                
                <a href="https://twitter.com/_fancyan" target="_blank"><i class="fab fa-twitter"></i></a>
                
                <a href="https://www.instagram.com/monophoton" target="_blank"><i class="fab fa-instagram"></i></a>
                
                <a href="https://github.com/hallucigenia" target="_blank"><i class="fab fa-github"></i></a>
                
            </div>
            

            <div class="languages">
                <strong></strong>
                
                
                <a href="https://bbyy.io/" class="active">tc</a>
                
                
                
                <a href="https://bbyy.io/sc/">sc</a>
                
                
                
                <a href="https://bbyy.io/en/">en</a>
                
                
            </div>
            
        </div>
    </div>
</footer>


<div class="credits">
    <div class="container">
        <div class="copyright">
            <a href="https://t.me/hallucigenia" target="_blank">
                &copy;
                
                2020
                
                by Fancy
            </a>
            
        </div>
        <div class="author">
            <a href="https://bbyy.io"
                target="_blank">Fancy&#39;s Blog</a>
        </div>
    </div>
</div>


    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-160694437-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


    


    <script type="text/javascript" src="https://bbyy.io/theme.js"></script>

    
    
    

    
    <div id="activate-algolia-search" class="hidden">
  <input type="hidden" id="algolia-search-appId" value="8JWRQ9KNXC">
  <input type="hidden" id="algolia-search-apiKey" value="0f05c447096335c55a457fe4cfaae96a">
  <input type="hidden" id="algolia-search-indexName" value="grimalog">
  <input type="hidden" id="algolia-search-noSearchResults" value="">

  
</div>

    


</body>

</html>
