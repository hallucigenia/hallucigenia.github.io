
  
<!doctype html>
<html class="no-js" lang="tc">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Fancy">
    <meta name="description" content="Bilberry Premium Theme for Hugo.">
    <meta name="keywords" content="blog,personal,responsive,search,font awesome,pages,posts,multilingual,highlight.js,syntax highlighting,premium,shortcuts">
    <meta name="generator" content="Hugo 0.67.0" />
    <title> 利用Redis做Flask緩存後端 | Fancy‘s Blog</title>
    <meta name="description" content="利用Redis做Flask緩存後端 - Bilberry Premium Theme for Hugo.">
    <meta itemprop="name" content="利用Redis做Flask緩存後端">
    <meta itemprop="description" content="利用Redis做Flask緩存後端 - Bilberry Premium Theme for Hugo.">
    <meta property="og:title" content="利用Redis做Flask緩存後端">
    <meta property="og:description" content="利用Redis做Flask緩存後端 - Bilberry Premium Theme for Hugo.">
    <meta property="og:image" content="https://www.gravatar.com/avatar/3776f719d93bf9d357bf83b6e50e10d6?size=200">
    <meta property="og:url" content="https://bbyy.io/code/flask-caching-with-redis/">
    <meta property="og:site_name" content="Fancy‘s Blog">
    <meta property="og:type" content="article">

    
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#ed5165">
<meta name="msapplication-TileColor" content="#ed5165">
<meta name="theme-color" content="#ed5165">

    
    <link href="/code/flask-caching-with-redis/" rel="alternate" type="application/rss+xml" title="Fancy‘s Blog" />
    <link href="/code/flask-caching-with-redis/" rel="feed" type="application/rss+xml" title="Fancy‘s Blog" />
    

    

    <link rel="stylesheet" href="https://bbyy.io/theme.css">

    

    
    
    
</head>

<body class="bilberry-hugo-theme">

    
    <nav>

    <div class="container">
        <ul class="topnav">
            
            
            <li><a href="https://bbyy.io/page/about-me/">關於本人</a></li>
            
            
        </ul>

        
        <div id="search-box" class="search">
            <i class="fas fa-search"></i>
            <input id="search" type="text" placeholder="">
        </div>
        
    </div>
</nav>


    
<header>

    <div class="container">
        <div class="logo">
            <a id="siteBaseUrl" href="/" class="logo">
                
                <img src="https://www.gravatar.com/avatar/3776f719d93bf9d357bf83b6e50e10d6?d=mm&size=200" alt="">
                

                <span class="overlay"><i class="fa fa-tape"></i></span>
            </a>
        </div>
        <div class="titles">
            <h3 class="title"><a
                    href="/">Fancy‘s Blog</a></h3>
            
            <span class="subtitle">Fancy的個人Blog，技術Blog可移步SC語言</span>
            
        </div>

        <div class="languages">
        
            
                <a href="https://bbyy.io/" class="active">tc</a>
            
        
            
                <a href="https://bbyy.io/sc/">sc</a>
            
        
            
                <a href="https://bbyy.io/en/">en</a>
            
        
        </div>
        

        
            <div class="toggler">
                
                <i class="fa fa-bars" aria-hidden="true"></i>
            </div>
        </div>
</header>


    <div class="main container">
        
     
    <div class="article-wrapper u-cf single">
        
            <a class="bubble" href="https://bbyy.io/code/flask-caching-with-redis/">
    <i class="fas fa-fw fa-code"></i>
</a>

<article class="default article">
    

    <div class="content">
    <h1 class="article-title"><a href="https://bbyy.io/code/flask-caching-with-redis/">利用Redis做Flask緩存後端</a></h1>
    <div class="meta">
        
        
        <span class="date moment">2019-04-01</span>
        
        

        
        <span class="readingTime"></span>
        

        
        <span class="categories">
            
                
                
                <a href="https://bbyy.io/categories/code/">Code</a>
                
            
        </span>
        

        
        <span class="author">
            
            
            <a href="https://bbyy.io/author/fancy/">Fancy</a>
            
        </span>
        
    </div>

    
    <p>Flask項目中使用Flask-Caching實現Redis緩存</p>
<blockquote>
<p>NoSQL數據庫中的Redis，其key-value支持的value類型相當豐富，數據庫完全保存在內存裏，支持使用硬盤持久化，甚至為數據結構服務器。基於Redis集群原理後期還可以做分布式緩存</p>
</blockquote>
<h1 id="使用-flask-caching">使用 Flask-Caching</h1>
<p>在這裏我們調用<a href="https://github.com/thadeusb/flask-cache">Flask-Caching</a>以更加便利的實現Redis的後端緩存。這次就以本Blog為例，典型化介紹Redis緩存的實現。
Flask-Caching基本的功能繼承於flask-cache，大致可以分為</p>
<ul>
<li>記憶參數型緩存：由@cached裝飾器實現</li>
<li>無記憶參數型緩存：由@memoize裝飾器實現</li>
</ul>
<p><em>Flask-Caching是Flask-Cache的fork版本，原來的Flask-Cache已經四年沒更新了，最後壹個版本只支持到python 3.3</em></p>
<pre><code>pipenv install flask-caching
</code></pre>
<p>如果沒有安裝redis必須的</p>
<pre><code>pipenv install redis
</code></pre>
<p>工廠函數裏實例化Cache類，創建壹個cache對象，如果沒實例化redis也是必須的(這裏我把拓展工廠函數分開了，根據自身情況做相應更改即可)：
<em>extensions.py :</em></p>
<pre><code>from redis import Redis
from flask_caching import Cache

# ...
redis = Redis()
cache = Cache(config={
    'CACHE_TYPE': 'redis',
    'CACHE_KEY_PREFIX': 'fancycache',
    'CACHE_REDIS_URL': 'redis://localhost:6379'
    })
</code></pre>
<p>這裏只是實例，Flask-Caching除了調用redis緩存後端之外還可以使用本地Python字典，uwsgi的緩存框架，mamcached等等，詳見<a href="https://pythonhosted.org/Flask-Caching/#configuring-flask-caching">官方文檔</a></p>
<p>其中<code>RedisCache</code>有以下字段可用：</p>
<table>
<thead>
<tr>
<th align="left">CACHE_TYPE&rsquo;: &lsquo;redis&rsquo;</th>
<th align="left">Flask-Caching調用redis緩存後端必須的字段</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">CACHE_DEFAULT_TIMEOUT</td>
<td align="left">未指定緩存超時時間時的默認緩存超時時間，默認為300秒</td>
</tr>
<tr>
<td align="left">CACHE_KEY_PREFIX</td>
<td align="left">在所有鍵之前添加的前綴。讓不同的應用程序可以使用相同的服務器。</td>
</tr>
<tr>
<td align="left">CACHE_REDIS_HOST</td>
<td align="left">Redis的服務主機，未指定則為<code>localhost</code>即<code>127.0.0.1</code></td>
</tr>
<tr>
<td align="left">CACHE_REDIS_PORT</td>
<td align="left">Redis的服務端口，默認即Redis默認為<code>6379</code></td>
</tr>
<tr>
<td align="left">CACHE_REDIS_PASSWORD</td>
<td align="left">Redis如指定密碼時的設置</td>
</tr>
<tr>
<td align="left">CACHE_REDIS_DB</td>
<td align="left">Redis的db庫（基於零號索引），默認為零</td>
</tr>
<tr>
<td align="left">CACHE_ARGS</td>
<td align="left">在緩存類實例化的時候會對該列表進行解包拆分並傳遞。</td>
</tr>
<tr>
<td align="left">CACHE_OPTIONS</td>
<td align="left">在緩存類實例化的時候會傳遞該字典</td>
</tr>
<tr>
<td align="left">CACHE_REDIS_URL</td>
<td align="left">連接到Redis服務器的URL，如：<code>redis://user:password@localhost:6379/2. </code>相當於把前面的幾點整合壹下，</td>
</tr>
</tbody>
</table>
<p>傳入參數並初始化拓展，註冊到app對象：
<em><strong>init</strong>.py :</em></p>
<pre><code>from cryptic.extensions import cache
# ...
def register_extensions(app):
    # ...
    cache.init_app(app)
</code></pre>
<h1 id="設置調試程序">設置調試程序</h1>
<p>這裏為了對比測試，我們可以在開發環境中安裝<a href="https://pypi.org/project/Flask-DebugToolbar/">Flask-DebugToolbar</a>來直觀的監測Redis後端緩存的狀態</p>
<p>安裝Flask-DebugToolbar:</p>
<pre><code>$ pipenv install flask-debugtoolbar --dev
</code></pre>
<blockquote>
<p>這裏我們看到資源消耗最高的，我們可以使用Celery異步任務隊列來優化，這裏目前沒太多要求，剛接觸Celery沒多久，Celery這個坑就留以後討論吧。
實例化並初始化：</p>
</blockquote>
<pre><code>from flask import Flask
from flask_debugtoolbar import DebugToolbarExtension

app = Flask(__name__)

app.debug = True
#意僅在debug模式啟用

app.config['SECRET_KEY'] = '&lt;replace with a secret key&gt;'
#設置以開啟cookies

toolbar = DebugToolbarExtension(app)
</code></pre>
<p>此時設置app.debug = False就可以關閉DebugToolbar了
運行時點擊右側的FDT即可開啟Flask-DebugToolbar側欄，
<img src="https://raw.githubusercontent.com/hallucigenia/grimalog/master/content/code/flask-caching-with-redis/01.png" alt="click" title="click"></p>
<p>另外，如果要載入性能分析器 可以點擊Profiler的勾，勾選後再次刷新即可看到加載時間，妳還可以點擊查看具體函數的運行性能，以更好的優化代碼。</p>
<p><strong>請最好不要在生產環境啟用</strong>，另外更方便設置環境變量可使用<code>flask-dotenv</code></p>
<h1 id="緩存視圖函數">緩存視圖函數</h1>
<p>壹般視圖函數緩存優先考慮計算較多，調用數據庫頻繁的視圖函數。並且更新不是很頻繁，對我們的Blog來說，壹般需要緩存的主要還是首頁，除了緩存主頁外，另外緩存下可能點擊多的視圖函數，以主頁為例，我的主頁裏放了文章預覽，在刷新後載入還是比較慢的。</p>
<pre><code>@blog_bp.route('/')
@cache.cached(timeout= 20 * 60, unless=is_login)
def index():
    time.sleep(1)  #根據函數復雜度可以調整或取消
    # ...
    return render_template('blog/index.html')
</code></pre>
<p>這裏我們需要設置壹個20分鐘過期時間，畢竟我除了自己應該不會在我博客停留這麽久，這裏如果不是很常改變的界面，可以設置壹個小時乃至更久。
我們可以傳入壹個<code>key_prefix</code>做緩存鍵，這樣的好處在於對Redis可以使用cache.clear()方法完全清除緩存。
其他界面也可以設置緩存，比如我把個人介紹頁就設置了二小時，文章頁設置了30分鐘，我們可以在本地測試壹下</p>
<p>未設置緩存的時候，平均刷新壹次主頁需要27ms左右，實際的博客會更長
<img src="https://raw.githubusercontent.com/hallucigenia/grimalog/master/content/code/flask-caching-with-redis/02.png" alt="未緩存的載入時間" title="uncaching">
而在部署完Redis緩存之後，近百倍的速度提升，這裏我的提升還不是很明顯
<img src="https://raw.githubusercontent.com/hallucigenia/grimalog/master/content/code/flask-caching-with-redis/03.png" alt="after redis" title="after redis"></p>
<h1 id="緩存其他函數">緩存其他函數</h1>
<p>Flask-Caching的支持不僅僅是視圖函數，妳可以緩存非視圖相關函數的結果，與緩存視圖函數不同，如果沒有傳入參數<code>key_prefix</code>關鍵字來替換默認的cache_key的話，它將會默認使用當前請求的<code>request.path</code>值作為cache_key，造成直接覆寫視圖函數數據的情況，這裏**務必使用<code>key_prefix</code></p>
<p>**面對復雜的函數可以繼續設置壹個<code>time.sleep()</code>以模擬估算運算時間。
我還沒有找到合適的應用地方，這裏以官方文檔給的實例代碼為例：</p>
<pre><code>@cache.cached(key_prefix='MyCachedList')
def get_list():
    return [random.randrange(0, 1) for i in range(50000)]
my_list = get_list()
</code></pre>
<p>#memoize()裝飾器</p>
<p>@cache.memoize()裝飾器與@cache.cached()用法類似，函數的參數也包含在cache_key中：不同的是 @cache.memoize() 裝飾器只會在再次調用相同參數時調用緩存，於是可以在函數接收到不同的實參後返回不同的結果.。 @cache.memoize() 不僅僅會緩存運行的結果, 還緩存調用時的參數值。</p>
<hr>
<p>#更新緩存</p>
<p>以上的緩存都是計時清理的模式，但是對於博客來說，登陸的時候以及退出登錄時如果沒有清理緩存將會使顯示錯誤，
cache.delete()方法可以刪除緩存，其參數key_prefix默認為 <code>‘view/%(request.path)s’</code>，我們使用url_for()定位的函數鍵替換他以刪除緩存</p>
<p><em>auth.py:</em></p>
<pre><code>@auth_bp.route('/login', methods=['GET', 'POST'])
def login():
    cache.delete('view/%s' % url_for('blog.index'))
    # ...
    return render_template('auth/login.html', form=form)


@auth_bp.route('/logout')
@login_required
def logout():
    cache.delete('view/%s' % url_for('blog.index'))
    logout_user()
    flash('Logout success.', 'info')
    return redirect_back()
</code></pre>
<p>相似的，如果我們新建了文章或者編輯了文章，為便於自己即時預覽新更改的內容，可以在新建編輯刪除文章的地方調用cache.delete()，例如：</p>
<p><em>admin.py :</em></p>
<pre><code>@admin_bp.route('/post/&lt;int:post_id&gt;/delete', methods=['POST'])
@login_required
def delete_post(post_id):
    cache.delete('view/%s' % url_for('blog.index'))
    post = Post.query.get_or_404(post_id)
    db.session.delete(post)
    db.session.commit()
    flash('Post deleted.', 'success')
    return redirect_back()
</code></pre>
<p>在我們刪除文章的時候，通過構建緩存鍵同步清除首頁緩存，再運行博客程序，就不會遇到刪除後文章還在的問題了。
另外在編輯文章的視圖函數，需要清除首頁和文章頁兩份的緩存</p>
<p><code>memoize()</code>裝飾器的緩存對應的方法為<code>delete_memorized()</code>使用方法相似。</p>
<p>還存在壹種<code>cache.clear()</code>的方法，可以實現清除緩存（某些後端實現並不支持）。對於我們的redis來說，倘若在其他地方也調用了Redis數據的話，壹定要確保使用<code>key_prefix</code>，否則<code>cache.clear()</code>將刷新整個數據庫。</p>
<p>其他大部分問題都可以詳見<a href="https://pythonhosted.org/Flask-Caching/">Flask-Caching的文檔</a>開發者寫的很詳細，目前我也在空閑時在Sphinx翻譯文檔，如果這邊合適的話我會多做做貢獻吧。</p>
<p>有錯漏之處，歡迎指正</p>
<blockquote>
<p>按：本計劃好好做下微信公眾號後端的，實在抱歉微信公眾號平臺那邊沒提前熟悉，沒想微信開放的權限束手束腳，尤其是對於個人公眾號，連認證的機會都沒有。但相關的項目我不會拋棄，未來如果有機會申請到開放我還是會繼續開發的，如果實在沒有機會，我會轉到<code>Telegram</code>Robot繼續實現，不必在壹棵假檳榔樹上吊死。</p>
</blockquote>
    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                    
                    
                    <a href="https://bbyy.io/tags/flask/">Flask</a>
                    
                
                    
                    
                    <a href="https://bbyy.io/tags/python/">Python</a>
                    
                
                    
                    
                    <a href="https://bbyy.io/tags/redis/">Redis</a>
                    
                
            </div>
        </div>
    

    
    <div class="languages">
        <i class="fa fa-language"></i>
        <div class="links">
            
                <a href="https://bbyy.io/sc/code/flask-caching-with-redis/">sc</a>
            
        </div>
    </div>
    
</div>

</article>

        
    </div>

    
        <div id="comments-container">
            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hallucigenia" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            

        </div>
    

     

    </div>

    
<footer>
    <div class="container">

        
        <div class="recent-posts">
            <strong></strong>
            <ul>
                
                <li>
                    <a href="https://bbyy.io/gallery/xtra400&#43;qss3233/">遗忘</a>
                </li>
                
                <li>
                    <a href="https://bbyy.io/gallery/c200&#43;sp3000/">朝花夕拾</a>
                </li>
                
                <li>
                    <a href="https://bbyy.io/quote/liu-yue-fei-shuang/">六月飛霜 - 林夕</a>
                </li>
                
                <li>
                    <a href="https://bbyy.io/code/kubernetes-get-start/">kubeadm搭建部署kubernetes集群</a>
                </li>
                
                <li>
                    <a href="https://bbyy.io/code/getting-started-gdb/">Python標準庫 —— pdb調試工具使用</a>
                </li>
                
                <li>
                    <a href="https://bbyy.io/quote/zui/">追 - 林夕</a>
                </li>
                
            </ul>
        </div>
        

        
        <div class="categories">
            <a href="/categories/"><strong></strong></a>
            <ul>
                
                <li>
                    <a href="/categories/code">Code
                        (11)</a>
                </li>
                
                <li>
                    <a href="/categories/lyric">Lyric
                        (3)</a>
                </li>
                
                <li>
                    <a href="/categories/travelling">Travelling
                        (3)</a>
                </li>
                
                <li>
                    <a href="/categories/music">Music
                        (2)</a>
                </li>
                
                <li>
                    <a href="/categories/eason">Eason
                        (1)</a>
                </li>
                
                <li>
                    <a href="/categories/holidays">Holidays
                        (1)</a>
                </li>
                
                <li>
                    <a href="/categories/privacy">Privacy
                        (1)</a>
                </li>
                
            </ul>
        </div>
        

        <div class="right">
            
            <div class="external-profiles">
                <strong></strong>

                
                <a href="https://twitter.com/_fancyan" target="_blank"><i class="fab fa-twitter"></i></a>
                
                <a href="https://www.instagram.com/monophoton" target="_blank"><i class="fab fa-instagram"></i></a>
                
                <a href="https://github.com/hallucigenia" target="_blank"><i class="fab fa-github"></i></a>
                
            </div>
            

            <div class="languages">
                <strong></strong>
                
                
                <a href="https://bbyy.io/" class="active">tc</a>
                
                
                
                <a href="https://bbyy.io/sc/">sc</a>
                
                
                
                <a href="https://bbyy.io/en/">en</a>
                
                
            </div>
            
        </div>
    </div>
</footer>


<div class="credits">
    <div class="container">
        <div class="copyright">
            <a href="https://t.me/hallucigenia" target="_blank">
                &copy;
                
                2020
                
                 by Fancy 
            </a>
            
        </div>
        <div class="author">
            <a href="https://bbyy.io"
                target="_blank">Fancy&#39;s Blog</a>
        </div>
    </div>
</div>


    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-160694437-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


    


    <script type="text/javascript" src="https://bbyy.io/theme.js"></script>

    
    
    

    
    <div id="activate-algolia-search" class="hidden">
  <input type="hidden" id="algolia-search-appId" value="8JWRQ9KNXC">
  <input type="hidden" id="algolia-search-apiKey" value="0f05c447096335c55a457fe4cfaae96a">
  <input type="hidden" id="algolia-search-indexName" value="grimalog">
  <input type="hidden" id="algolia-search-noSearchResults" value="">

  
</div>

    


</body>

</html>
